const protocol="https:"===window.location.protocol?"wss":"ws",port="https:"===window.location.protocol?"":":81";let gateway=`${protocol}://${window.location.hostname}${port}/ws`,websocket;function initWebSocket(){(websocket=new WebSocket(gateway)).binaryType="arraybuffer",websocket.onclose=onClose,websocket.onmessage=onMessage}const canvas=document.getElementById("canvas"),guide=document.getElementById("guide"),clearButton=document.getElementById("clearButton"),brushSizeSelector=document.getElementById("brush-select"),drawing=canvas.getContext("2d"),eraserToggle=document.getElementById("eraserToggleCheckbox");canvas.width=896,canvas.height=448;let physicalDisplayWidth=128,physicalDisplayHeight=64;const canvasMultiplier=7;let brushSize=1,horizontalCellCount=physicalDisplayWidth/brushSize,verticalCellCount=physicalDisplayHeight/brushSize,cellSideLength=canvas.width/horizontalCellCount,lastX=-1,lastY=-1,eraserOn=!1,eraserStateChanged=!1,isDrawing=!1;function onClose(e){console.log("Connection closed"),setTimeout(initWebSocket,2e3)}function grayscaleThreshold(e){let t=Array(256).fill(0);for(let a=0;a<e.data.length;a+=4){let l=e.data[a];t[l]++}let n=0,i=0,s=0,o=0,r=0;for(let c=0;c<t.length;c++)n+=c*t[c];for(let d=0;d<t.length;d++){i+=t[d],s=n-i;let h=0===i?0:n/i,g=0===s?0:(n-i*h)/s,u=i*s*(h-g)*(h-g);u>r&&(r=u,o=d)}return o}function parsePixelCommand(e){let t=JSON.parse(e.data);if(t.clear)drawing.fillStyle="#242526",drawing.fillRect(0,0,canvas.width,canvas.height);else{t.pixelOn?drawing.fillStyle="#FFFFFF":drawing.fillStyle="#242526";let a=7*t.x,l=7*t.y,n=canvas.width/(physicalDisplayWidth/t.size);drawing.fillRect(a,l,n,n)}}function parseCanvasState(e){let t=new Uint8Array(e.data);for(let a=0;a<physicalDisplayHeight;a++)for(let l=0;l<physicalDisplayWidth;l++){let n=Math.floor((a*physicalDisplayWidth+l)/8),i=7-(a*physicalDisplayWidth+l)%8;t[n]>>i&1?drawing.fillStyle="#FFFFFF":drawing.fillStyle="#242526",drawing.fillRect(7*l,7*a,7,7)}}function onMessage(e){"string"==typeof e.data?parsePixelCommand(e):e.data instanceof ArrayBuffer&&parseCanvasState(e)}function setupGridGuides(){let e=guide.querySelectorAll("div");e.forEach(e=>e.remove()),guide.style.width=`${canvas.width}px`,guide.style.height=`${canvas.height}px`,guide.style.gridTemplateColumns=`repeat(${horizontalCellCount}, 1fr)`,guide.style.gridTemplateRows=`repeat(${verticalCellCount}, 1fr)`;for(let t=0;t<horizontalCellCount*verticalCellCount;t++)guide.insertAdjacentHTML("beforeend","<div></div>")}function sendChangeToServer(e,t){let a={clear:!1,pixelOn:!eraserOn,x:Math.floor(e/7),y:Math.floor(t/7),size:brushSize};try{websocket.send(JSON.stringify(a))}catch(l){console.log(l)}}function fillCell(e,t){sendChangeToServer(e,t),eraserOn?drawing.fillStyle="#242526":drawing.fillStyle="#FFFFFF",drawing.fillRect(e,t,cellSideLength,cellSideLength)}function mouseMoved(e){let t=canvas.getBoundingClientRect(),a=e.clientX-t.left,l=e.clientY-t.top;inputMoved(a,l)}function mouseDown(e){isDrawing=!0,mouseMoved(e)}function mouseUp(e){isDrawing=!1}function touchMoved(e){let t=canvas.getBoundingClientRect(),a=e.touches[0].clientX-t.left,l=e.touches[0].clientY-t.top;inputMoved(a,l)}function touchStart(e){e.preventDefault(),isDrawing=!0,touchMoved(e)}function inputMoved(e,t){if(isDrawing){let a=Math.floor(e/cellSideLength)*cellSideLength,l=Math.floor(t/cellSideLength)*cellSideLength;(a!=lastX||l!=lastY||eraserStateChanged)&&(eraserStateChanged=!1,fillCell(a,l),lastX=a,lastY=l)}}function clearCanvas(){let e=confirm("Are you sure you wish to clear the canvas?");if(e){drawing.fillStyle="#242526",drawing.fillRect(0,0,canvas.width,canvas.height);try{websocket.send(JSON.stringify({clear:!0}))}catch(t){console.log(t)}}}function brushChanged(e){horizontalCellCount=128/(brushSize=parseInt(e.target.value)),verticalCellCount=64/brushSize,cellSideLength=canvas.width/horizontalCellCount,setupGridGuides()}function eraserToggled(e){eraserOn=!eraserOn,eraserStateChanged=!0}drawing.fillStyle="#242526",drawing.fillRect(0,0,canvas.width,canvas.height),setupGridGuides(),initWebSocket(),document.getElementById("imageUpload").addEventListener("change",function(e){let t=new Image;t.src=window.URL.createObjectURL(e.target.files[0]),t.onload=function(){let e=document.createElement("canvas"),a=e.getContext("2d"),l=Math.min(physicalDisplayWidth/t.width,physicalDisplayHeight/t.height);e.width=t.width*l,e.height=t.height*l,a.drawImage(t,0,0,physicalDisplayWidth,physicalDisplayHeight);let n=new Uint8Array(1024),i=a.getImageData(0,0,physicalDisplayWidth,physicalDisplayHeight).data,s=grayscaleThreshold(i);for(let o=0;o<32768;o+=4){let r=.2126*i[o]+.7152*i[o+1]+.0722*i[o+2]>s?1:0,c=o/4,d=Math.floor(c/8),h=7-c%8;n[d]|=r<<h}websocket.send(n.buffer)}}),canvas.addEventListener("touchstart",touchStart,{passive:!1}),canvas.addEventListener("touchend",mouseUp,{passive:!1}),canvas.addEventListener("touchcancel",mouseUp,{passive:!1}),canvas.addEventListener("touchmove",touchMoved,{passive:!1}),canvas.addEventListener("mousemove",mouseMoved),canvas.addEventListener("mousedown",mouseDown),canvas.addEventListener("mouseup",mouseUp),canvas.addEventListener("mouseout",mouseUp),brushSizeSelector.addEventListener("change",brushChanged),eraserToggle.addEventListener("change",eraserToggled),clearButton.addEventListener("click",clearCanvas);