const protocol="https:"===window.location.protocol?"wss":"ws";let gateway=`${protocol}://${window.location.hostname}/ws`,websocket,lastCellX=-1,lastCellY=-1,eraserStateChanged=!1;function initWebSocket(){(websocket=new WebSocket(gateway)).onclose=onClose,websocket.onmessage=onMessage}function onClose(e){console.log("Connection closed"),setTimeout(initWebSocket,2e3)}function onMessage(e){let t=JSON.parse(e.data);if(t.clearFlag)drawingContext.fillStyle="#242526",drawingContext.fillRect(0,0,canvas.width,canvas.height);else{t.color?drawingContext.fillStyle="#FFFFFF":drawingContext.fillStyle="#242526";let l=t.x*canvasMultiplier,a=t.y*canvasMultiplier,n=canvas.width/(physicalDisplayWidth/t.cellSize);drawingContext.fillRect(l,a,n,n)}}const canvas=document.getElementById("canvas"),guide=document.getElementById("guide"),clearButton=document.getElementById("clearButton"),brushSizeSelector=document.getElementById("brush-select"),drawingContext=canvas.getContext("2d"),eraserToggle=document.getElementById("eraserToggleCheckbox"),canvasMultiplier=7;canvas.width=896,canvas.height=448;let physicalDisplayWidth=128,physicalDisplayHeight=64,scaleFactor=1,horizontalCellCount=physicalDisplayWidth/scaleFactor,verticalCellCount=physicalDisplayHeight/scaleFactor,cellSideLength=canvas.width/horizontalCellCount,eraserOn=!1,isDrawing=!1;function setupGridGuides(){let e=guide.querySelectorAll("div");e.forEach(e=>e.remove()),guide.style.width=`${canvas.width}px`,guide.style.height=`${canvas.height}px`,guide.style.gridTemplateColumns=`repeat(${horizontalCellCount}, 1fr)`,guide.style.gridTemplateRows=`repeat(${verticalCellCount}, 1fr)`;for(let t=0;t<horizontalCellCount*verticalCellCount;t++)guide.insertAdjacentHTML("beforeend","<div></div>")}function fillCell(e,t){let l={clearFlag:0,color:1,x:Math.floor(e/canvasMultiplier),y:Math.floor(t/canvasMultiplier),cellSize:scaleFactor};eraserOn?(drawingContext.fillStyle="#242526",l.color=0):drawingContext.fillStyle="#FFFFFF";try{websocket.send(JSON.stringify(l))}catch(a){console.log(a)}drawingContext.fillRect(e,t,cellSideLength,cellSideLength)}function mouseMoved(e){if(isDrawing){let t=canvas.getBoundingClientRect(),l=e.clientX-t.left,a=e.clientY-t.top,n=Math.floor(l/cellSideLength)*cellSideLength,i=Math.floor(a/cellSideLength)*cellSideLength;(n!=lastCellX||i!=lastCellY||eraserStateChanged)&&(eraserStateChanged=!1,fillCell(n,i),lastCellX=n,lastCellY=i)}}function clearCanvas(){let e=confirm("Are you sure you wish to clear the canvas?");if(e){drawingContext.fillStyle="#242526",drawingContext.fillRect(0,0,canvas.width,canvas.height);try{websocket.send(JSON.stringify({clearFlag:1}))}catch(t){console.log(t)}}}function mouseDown(e){isDrawing=!0,mouseMoved(e)}function mouseUp(e){isDrawing=!1}function brushChanged(e){horizontalCellCount=128/(scaleFactor=parseInt(e.target.value)),verticalCellCount=64/scaleFactor,cellSideLength=canvas.width/horizontalCellCount,setupGridGuides()}function eraserToggled(e){eraserOn=!eraserOn,eraserStateChanged=!0}drawingContext.fillStyle="#242526",drawingContext.fillRect(0,0,canvas.width,canvas.height),setupGridGuides(),initWebSocket(),canvas.addEventListener("mousemove",mouseMoved),canvas.addEventListener("mousedown",mouseDown),canvas.addEventListener("mouseup",mouseUp),canvas.addEventListener("mouseout",mouseUp),brushSizeSelector.addEventListener("change",brushChanged),eraserToggle.addEventListener("change",eraserToggled),clearButton.addEventListener("click",clearCanvas);